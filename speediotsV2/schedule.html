<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Schedule — Speediots Racing</title>
    <link rel="stylesheet" href="styles.css">
  </head>
  <body>
  <header class="site-header">
      <div class="container header-inner">
        <div class="logo">SPEEDIOTS</div>
        <nav class="main-nav">
          <a href="index.html">Home</a>
          <a href="rules.html">Rules</a>
          <a href="schedule.html">Schedule</a>
          <a href="news.html">News</a>
          <a href="supporters.html">Supporters</a>
            <div class="classes-link" style="display:inline-block;">
              Classes
              <div class="mega-menu">
                <a href="gt3.html">GT3</a>
                <a href="nascar.html">Nascar</a>
                <a href="gt4.html">GT4</a>
                <a href="gt2.html">GT2</a>
              </div>
            </div>
          <a href="register.html" class="btn primary">Register</a>
        </nav>
      </div>
    </header>

    <main class="container">
      <h1>Racing Schedule</h1>
      <div class="form-wrap">
        <div style="display:flex;justify-content:space-between;align-items:center;gap:1rem;flex-wrap:wrap">
          <p style="margin:0">Upcoming 2 weeks — add races (owner only)</p>
          <div>
            <button id="add-race-btn" class="btn">Add race</button>
            <small style="color:var(--muted);margin-left:.6rem">(owner-only — client-side)</small>
          </div>
        </div>
        <div id="calendar" style="margin-top:1rem"></div>
      </div>
    </main>

    <script>
    (function(){
      // Simple client-side calendar showing next 14 days and storing events in localStorage.
      const OWNER_PASS = 'letmein'; // change this to a secure passphrase
      const classes = ['GT3','Nascar','GT4','GT2'];

      function startOfDay(d){ const x = new Date(d); x.setHours(0,0,0,0); return x; }
      function formatDate(d){ return d.toLocaleDateString(undefined,{weekday:'short',month:'short',day:'numeric'}); }

      const storageKey = 'speediots_events_v1';
      function loadEvents(){ try{ return JSON.parse(localStorage.getItem(storageKey)||'[]'); }catch(e){return[]} }
      function saveEvents(evts){ localStorage.setItem(storageKey, JSON.stringify(evts)); }

      function renderCalendar(){
        const cal = document.getElementById('calendar'); cal.innerHTML = '';
        const today = startOfDay(new Date());
        const events = loadEvents();
        for(let i=0;i<14;i++){
          const day = new Date(today); day.setDate(today.getDate()+i);
          const dayISO = day.toISOString().slice(0,10);
          const dayEvents = events.filter(e=>e.date===dayISO).sort((a,b)=> (a.time||'')>(b.time||'')?1:-1);

          const dayCard = document.createElement('div'); dayCard.className='calendar-day reveal';
          dayCard.style.marginTop='0.6rem'; dayCard.style.padding='0.8rem'; dayCard.style.background='var(--card)'; dayCard.style.borderRadius='8px';

          const header = document.createElement('div'); header.style.display='flex'; header.style.justifyContent='space-between'; header.style.alignItems='center';
          const title = document.createElement('div'); title.innerText = formatDate(day);
          const addBtn = document.createElement('button'); addBtn.className='btn'; addBtn.innerText='Add'; addBtn.style.fontSize='0.9rem';
          addBtn.addEventListener('click', ()=>ownerAddOnDate(dayISO));
          header.appendChild(title); header.appendChild(addBtn);

          dayCard.appendChild(header);

          const list = document.createElement('div'); list.style.marginTop='0.6rem';
          if(dayEvents.length===0){ const p = document.createElement('div'); p.style.color='var(--muted)'; p.innerText='No races'; list.appendChild(p);} 
          else{
            dayEvents.forEach(ev=>{
              const evDiv = document.createElement('div'); evDiv.className='race-item'; evDiv.style.padding='.5rem'; evDiv.style.marginBottom='.4rem'; evDiv.style.borderRadius='6px'; evDiv.style.background='linear-gradient(90deg, rgba(255,255,255,0.02), rgba(0,0,0,0.02))';
              const h = document.createElement('div'); h.style.display='flex'; h.style.justifyContent='space-between';
              const left = document.createElement('div'); left.innerHTML = `<strong>${ev.title}</strong> <small style="color:var(--muted);margin-left:.6rem">${ev.time||''} • ${ev.class||''}</small>`;
              const right = document.createElement('div');
              const more = document.createElement('button'); more.className='btn'; more.style.fontSize='0.85rem'; more.innerText='Details';
              right.appendChild(more);
              h.appendChild(left); h.appendChild(right);
              evDiv.appendChild(h);
              const details = document.createElement('div');
              details.className = 'race-details';
              details.style.marginTop='.5rem';

              // inner content wrapper so we can measure scrollHeight
              const content = document.createElement('div'); content.className='details-content';
              const txt = document.createElement('div'); txt.innerText = ev.details||'';
              content.appendChild(txt);

              // helper to count race entries for this event (by eventId if present, fallback to class+title)
              function getEntryCount(){
                try{
                  const entries = JSON.parse(localStorage.getItem('speediots_race_entries')||'[]');
                  return entries.filter(en => (en.eventId && String(en.eventId) === String(ev.id)) || (!en.eventId && en.class === ev.class && en.title === ev.title)).length;
                }catch(e){ return 0; }
              }

              const counter = document.createElement('div');
              counter.style.color='var(--muted)'; counter.style.marginBottom='.4rem';
              counter.textContent = `Entries: ${getEntryCount()}`;
              content.appendChild(counter);

              const moreInfo = document.createElement('a'); moreInfo.className='btn primary'; moreInfo.style.display='inline-block'; moreInfo.style.marginTop='.5rem'; moreInfo.style.textDecoration='none';
              const cls = (ev.class||'').toLowerCase();
              moreInfo.href = cls ? `${cls}.html` : 'news.html'; moreInfo.innerText='More info';
              moreInfo.target='_blank';

              // register for this race button (links to race-register.html)
              const raceReg = document.createElement('a'); raceReg.className='btn'; raceReg.style.display='inline-block'; raceReg.style.marginTop='.5rem'; raceReg.style.marginLeft='.5rem';
              const params = new URLSearchParams({ cls: ev.class||'', title: ev.title||'', id: ev.id });
              raceReg.href = `race-register.html?${params.toString()}`;
              raceReg.innerText = 'Register';

              // delete button (owner-controlled)
              const delBtn = document.createElement('button'); delBtn.className='btn danger'; delBtn.style.display='inline-block'; delBtn.style.marginTop='.5rem'; delBtn.style.marginLeft='.5rem'; delBtn.innerText='Delete';
              delBtn.addEventListener('click', (e)=>{
                e.preventDefault();
                const pass = prompt('Enter owner passphrase to delete this race');
                if(pass!==OWNER_PASS){ alert('Wrong passphrase'); return; }
                const evs = loadEvents().filter(x=>x.id !== ev.id);
                saveEvents(evs);
                renderCalendar();
              });

              const btnWrap = document.createElement('div'); btnWrap.style.marginTop='.5rem';
              btnWrap.appendChild(moreInfo); btnWrap.appendChild(raceReg); btnWrap.appendChild(delBtn);
              content.appendChild(btnWrap);

              details.appendChild(content);

              more.addEventListener('click', ()=>{
                // update counter when opening
                counter.textContent = `Entries: ${getEntryCount()}`;
                // smooth toggle via max-height
                if(details.style.maxHeight && details.style.maxHeight !== '0px'){
                  details.style.maxHeight = '0px';
                } else {
                  // set to scrollHeight to expand
                  details.style.maxHeight = (content.scrollHeight + 12) + 'px';
                }
              });

              evDiv.appendChild(details);
              list.appendChild(evDiv);
            });
          }

          dayCard.appendChild(list);
          cal.appendChild(dayCard);
        }
        document.querySelectorAll('.reveal').forEach(el=>el.classList.remove('in-view'));
        setTimeout(()=>{ document.querySelectorAll('.reveal').forEach(el=>el.classList.add('in-view')); },120);
      }

      function ownerAddOnDate(dateISO){
        const pass = prompt('Enter owner passphrase to add a race');
        if(pass!==OWNER_PASS){ alert('Wrong passphrase'); return; }
        const title = prompt('Race title (short)'); if(!title) return;
        const cls = prompt('Class (GT3, Nascar, GT4, GT2)'); if(!cls) return;
        const time = prompt('Time (e.g. 13:00)') || '';
        const details = prompt('Short details / notes') || '';
        const events = loadEvents();
        events.push({ id: Date.now(), date: dateISO, title, class: cls, time, details });
        saveEvents(events);
        renderCalendar();
      }

      document.getElementById('add-race-btn').addEventListener('click', ()=>{
        ownerAddOnDate(new Date().toISOString().slice(0,10));
      });
      renderCalendar();
    })();
    </script>

    <footer class="site-footer">
      <div class="container footer-inner">
        <div>© <span id="year"></span> Speediots Racing</div>
        <div class="footer-links">
          <a href="index.html">Home</a>
        </div>
      </div>
    </footer>

    <script src="scripts.js"></script>
  </body>
</html>
